
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <title>Index</title>
    <style>
        .c {
            width: 200px;
            height: 200px;
            background-color: white;
            position: absolute;
            z-index: 200;
            opacity: 0.8;
            display:flex;
            align-items:center;
            justify-content:center;
        }

        .cc {
            display:none;
        }

        .b {
            width: 200px;
            height: 200px;
            position: absolute;
            z-index: 20;
        }
        .a {
            position: relative;
            width: 200px;
            height: 200px;
        }
    </style>
</head>
<body>
    <div class="a">
        <div class="b">
            <img src="" id="image" style="width:200px;height:200px;" alt="二维码" class="img-rounded">
        </div>
        <div class="c cc" ><span>二维码已过期，请刷新二维码</span></div>
    </div>
  
    <div>
        <button id="dj">传递 sql 二维码</button>
        <button id="ajax">ajax</button>
    </div>

    <script src="~/Scripts/jquery-3.4.1.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <script>


        $("#dj").click(function () {
            var ddtime = new Date().getTime();
            console.log(window.location.host);
            var dd = "wss://192.168.131.211:44397/api/QrCodeApi/Qrcode?rqID=" + ddtime;
            ws = new WebSocket(dd);
            ws.onopen = function () {
                console.log(ws.readyState);
                if (ws.readyState == WebSocket.OPEN)
                {
                    ws.send(ddtime);
                }
            }
            $(".c").addClass("cc");
            ws.onmessage = function (evt) {
                console.log(evt.data);
                console.log(typeof (evt.data))
                if (evt.data == "2")
                {
                    $(".c").removeClass("cc");
                    return;
                }
                var blo = new Blob([evt.data]);
                var cc = window.URL.createObjectURL(blo);
                var c = document.createElement("a");
                $("#image").attr("src", cc);
                //c.download = "1234.jpg";
                //c.style.display = "none";
                //c.href = cc;
                //document.body.appendChild(c);
                //c.click();
                //document.body.removeChild(c);
            }
            ws.onerror = function (evt) {
                $('#msg').append('<p>' + JSON.stringify(evt) + '</p>');
            }
            ws.onclose = function () {
                $('#msg').append('<p>已经关闭</p>');
            }
            // ws.onopen();
            console.log(ws.readyState);

            //var xml = new XMLHttpRequest();
            //xml.open('get', '/qrCode/qrCodes', true);
            //xml.setRequestHeader("Accept", "application/json;q=0.5");
            //xml.setRequestHeader("Content-Type", "application/w-www-form-urlencoded");
            //xml.responseType = "blob";
            //xml.onload = function () {
            //    if (this.status == 200) {
            //        console.log(xml.response);
            //        var blo = new Blob([xml.response]);
            //        //urlencoded 使用FileReader将文件流转换成base64格式；
            //        var cc = window.URL.createObjectURL(blo);
            //        $("#image").attr("src", cc);
            //        //var c = document.createElement("a");
            //        //c.download = "1234.jpg";
            //        //c.style.display = "none";
            //        //c.href = cc;
            //        //document.body.appendChild(c);
            //        //c.click();
            //        //document.body.removeChild(c);
            //        //var reader = new FileReader();
            //        //reader.readAsDataURL(blob);
            //        //reader.onload = function ()
            //        //{
            //        //    $("#image").attr("src", reader.result);
            //        //}
            //    }
            //}
            //xml.send();

            //WebSocket.bufferedAmount();
        })
        if ("WebSocket" in window) {
            console.log("您的浏览器支持WebSocket");
            var ws = new WebSocket("wss://192.168.131.211:44397"); //创建 webscoket
            console.log(ws.readyState);
            ws.onopen = function () {
                //当WebSocket创建成功时，触发onopen事件
                console.log(ws.readyState);
                ws.send("hello"); //将消息发送到服务端
            }
            ws.onmessage = function (e) {
                //当客户端收到服务端发来的消息时，触发onmessage事件，参数e.data包含server传递过来的数据
                console.log(e.data);
            }
            ws.onclose = function () {
                //当客户端收到服务端发送的关闭连接请求时，触发onclose事件
                console.log("close");
            }
            ws.onerror = function (e) {
                //如果出现连接、处理、接收、发送数据失败的时候触发onerror事件
                console.log(e.error);
            }
            //ws.onopen();

            ws.CLOSED
        }
        else {
            console.log("您的浏览器不支持WebSocket");
        }
//console.log(window.location.href);
//console.log(window.location.hostname);
    </script>
</body>
</html>
